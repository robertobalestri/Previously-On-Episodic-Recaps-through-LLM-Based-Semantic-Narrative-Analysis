# Plan: Scene-to-Arc Mapping Agent

This document outlines the plan for creating a new agent responsible for assigning identified narrative arcs to specific plot scenes within an episode.

### 1. Path Handling Extension

To manage the new data file, the existing path management system will be extended:

-   **Inspect `PathHandler`:** The first step is to analyze `backend/src/path_handler.py` to understand the current conventions for generating file paths.
-   **Add New Path Method:** A new method will be added to the `PathHandler` class. This method, tentatively named `get_scene_arc_mapping_path(season, episode)`, will generate a standardized, absolute path for the file that will store the mapping between scenes and narrative arcs. This ensures that all file paths remain centrally managed and consistent.

### 2. New Module for Scene-Arc Linking

A new, self-contained module will be created to house the logic for this new agent, following the project's modular design:

-   **Create Directory:** A new directory will be created at `backend/src/scene_narrative_arc_linking/`.
-   **Primary Logic File:** Inside this new directory, a file named `scene_arc_linker.py` will be created to hold the core implementation of the agent.

### 3. Core Logic Implementation (`scene_arc_linker.py`)

The `scene_arc_linker.py` file will contain the primary service function that drives the scene-to-arc mapping process.

-   **Define Service Function:** The main function will be named `link_arcs_to_scenes(season, episode)`.
-   **Data Loading:** This function will use the `PathHandler` to read two key input files:
    1.  The file containing the list of all narrative arcs previously identified for the episode.
    2.  The file containing the processed plot scenes for that same episode.
-   **LLM-Powered Agent:** The core of the agent will be an LLM call for each scene. The process will be as follows:
    -   For each scene, a carefully crafted prompt will be sent to the LLM.
    -   **Prompt Context:** The prompt will include the full list of all narrative arcs for the episode (e.g., "Arc A: Character X strives for redemption," "Arc B: The mystery of the missing artifact unfolds").
    -   **Prompt Task:** The prompt will also contain the text of a single plot scene.
    -   **Prompt Instruction:** The LLM will be instructed: "Analyze the given scene and identify which of the provided narrative arcs are actively present or advanced within it. Return a list of the names of the relevant narrative arcs."
-   **Result Aggregation:** The service will iterate through all scenes, execute the LLM call for each, and aggregate the results into a single, structured data format (e.g., a dictionary where keys are scene identifiers and values are lists of arc names).

### 4. Data Models and Storage

To ensure data consistency and validity, Pydantic models will be used:

-   **Define Data Models:** A new file, `backend/src/scene_narrative_arc_linking/models.py`, will be created to define the structure of the output data.
-   **Save Results:** The aggregated results will be serialized into a JSON file and saved to the location generated by the `PathHandler`'s new `get_scene_arc_mapping_path` method.

### 5. Pipeline Integration

Finally, the new agent will be integrated into the main processing pipeline:

-   **Update Pipeline:** The `api/services/processing_pipeline.py` file will be modified to include a new stage.
-   **Execution Order:** The scene-to-arc linking step will be added to the pipeline, ensuring it runs after the narrative arc extraction stage is complete. This makes it a seamless part of the overall episode processing workflow.
